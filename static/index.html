<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chat + Video</title>
</head>
<body>
  <h2>Login / Register</h2>
  <input id="username" placeholder="Username">
  <input id="password" type="password" placeholder="Password">
  <button onclick="register()">Register</button>
  <button onclick="login()">Login</button>

  <h2>Chat</h2>
  <input id="receiver" placeholder="Receiver ID">
  <input id="message" placeholder="Message">
  <button onclick="sendMessage()">Send</button>
  <button onclick="sendFile()">Send File</button>
  <button onclick="startCall()">Call</button>

  <div id="inbox"></div>

  <h2>Video Call</h2>
  <video id="localVideo" autoplay muted></video>
  <video id="remoteVideo" autoplay></video>

<script>
let userId = null;
let ws = null;
let pc = null;

async function register(){
  let res = await fetch("/register", {
    method:"POST",
    body:new FormData(Object.assign(new FormData(), {
      username: username.value, password: password.value
    }))
  });
  let data = await res.json();
  if(data.status==="ok"){ alert("Registered. Your ID: "+data.user_id); userId=data.user_id; }
  else alert(data.msg);
}

async function login(){
  let fd = new FormData();
  fd.append("username", username.value);
  fd.append("password", password.value);
  let res = await fetch("/login",{method:"POST",body:fd});
  let data = await res.json();
  if(data.status==="ok"){ alert("Logged in. ID:"+data.user_id); userId=data.user_id; connectWS(); }
  else alert(data.msg);
}

async function sendMessage(){
  let fd = new FormData();
  fd.append("sender", userId);
  fd.append("receiver", receiver.value);
  fd.append("content", message.value);
  await fetch("/send_message",{method:"POST",body:fd});
}

async function sendFile(){
  let fd = new FormData();
  fd.append("sender", userId);
  fd.append("receiver", receiver.value);
  fd.append("file", document.createElement("input").files[0]);
  await fetch("/send_file",{method:"POST",body:fd});
}

function connectWS(){
  ws = new WebSocket(`ws://${location.host}/ws/${userId}`);
  ws.onmessage = async e=>{
    let data = JSON.parse(e.data);
    if(data.type==="offer"){
      pc = createPeer();
      await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
      let answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      ws.send(JSON.stringify({to:data.from,type:"answer",sdp:answer}));
    } else if(data.type==="answer"){
      await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
    } else if(data.type==="candidate"){
      try { await pc.addIceCandidate(data.candidate); } catch(e){}
    }
  };
}

function createPeer(){
  let pc = new RTCPeerConnection();
  pc.ontrack = e => { document.getElementById("remoteVideo").srcObject = e.streams[0]; };
  pc.onicecandidate = e=>{
    if(e.candidate) ws.send(JSON.stringify({to:receiver.value,type:"candidate",candidate:e.candidate}));
  };
  return pc;
}

async function startCall(){
  pc = createPeer();
  try{
    let stream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
    document.getElementById("localVideo").srcObject = stream;
    stream.getTracks().forEach(t=>pc.addTrack(t,stream));
  }catch(e){
    console.log("No camera/mic", e);
  }
  let offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  ws.send(JSON.stringify({to:receiver.value,type:"offer",sdp:offer}));
}
</script>
</body>
</html>
