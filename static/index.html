<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>HackerChat Web</title>
<style>
body {
    margin: 0;
    font-family: monospace;
    background: black;
    color: #0f0;
}
#header {
    padding: 10px;
    border-bottom: 1px solid #0f0;
    background: #010;
}
#container {
    display: flex;
    height: calc(100vh - 40px);
}
#users {
    width: 250px;
    background: #010;
    overflow-y: auto;
    border-right: 1px solid #0f0;
    padding: 5px;
}
#chat {
    flex: 1;
    display: flex;
    flex-direction: column;
}
#messages {
    flex: 1;
    padding: 10px;
    overflow-y: auto;
}
#inputForm {
    display: flex;
    border-top: 1px solid #0f0;
}
#inputForm input {
    flex: 1;
    background: black;
    color: #0f0;
    border: none;
    padding: 10px;
    font-family: monospace;
}
#inputForm button {
    background: #0f0;
    color: black;
    border: none;
    padding: 10px 15px;
    cursor: pointer;
}
.user-item {
    padding: 5px;
    cursor: pointer;
}
.user-item:hover { background: #020; }
.user-item.active { background: #050; }
#addContactBtn {
    margin: 5px;
    padding: 5px;
    background: #0f0;
    color: black;
    cursor: pointer;
    text-align: center;
}
</style>
</head>
<body>

<div id="header">
    Your ID: <span id="myId">loading...</span>
</div>

<div id="container">
    <div id="users">
        <div id="addContactBtn">+ Add Contact</div>
    </div>
    <div id="chat">
        <div id="messages"></div>
        <form id="inputForm">
            <input id="messageInput" autocomplete="off" placeholder="Type a message"/>
            <button>Send</button>
        </form>
    </div>
</div>

<script>
const SERVER = window.location.origin;  
let userId = localStorage.getItem("userId");
let displayName = localStorage.getItem("displayName");
let contacts = JSON.parse(localStorage.getItem("contacts")||"[]");
let selectedUser = null;

// -------- Регистрация --------
async function registerUser() {
    displayName = prompt("Enter your nickname:") || "Anon";
    const resp = await fetch(SERVER+"/register", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({display_name: displayName})
    });
    const data = await resp.json();
    userId = data.user_id;
    localStorage.setItem("userId", userId);
    localStorage.setItem("displayName", displayName);
}

// -------- Контакты --------
async function addContact() {
    const newId = prompt("Enter the ID of the user you want to chat with:");
    if(!newId) return;

    // Проверка — существует ли такой пользователь
    const resp = await fetch(SERVER+"/user/"+newId);
    const data = await resp.json();
    if(data.error){
        alert("User not found!");
        return;
    }

    if(!contacts.find(c => c.id===newId)){
        const newUser = {id:data.id, display_name:data.display_name || data.id.substring(0,8)};
        contacts.push(newUser);
        localStorage.setItem("contacts", JSON.stringify(contacts));
    }
    renderContacts();
}

function renderContacts(){
    const usersDiv = document.getElementById("users");
    usersDiv.innerHTML = '<div id="addContactBtn">+ Add Contact</div>';
    document.getElementById("addContactBtn").onclick = addContact;
    contacts.forEach(u=>{
        const div = document.createElement("div");
        div.textContent = u.display_name;
        div.className = "user-item";
        div.onclick = ()=>{
            selectedUser = u;
            document.querySelectorAll(".user-item").forEach(el=>el.classList.remove("active"));
            div.classList.add("active");
            loadMessages();
        };
        usersDiv.appendChild(div);
    });
}

// -------- Сообщения --------
async function loadMessages(){
    if(!selectedUser) return;
    const resp = await fetch(`${SERVER}/inbox/${userId}`);
    const msgs = await resp.json();
    const chatDiv = document.getElementById("messages");
    chatDiv.innerHTML = "";
    msgs.forEach(m=>{
        if(m.sender === selectedUser.id || m.sender===userId){
            const div = document.createElement("div");
            div.textContent = (m.sender===userId?"Me":selectedUser.display_name) + ": " + m.text;
            chatDiv.appendChild(div);
        }
    });
    chatDiv.scrollTop = chatDiv.scrollHeight;
}

// -------- Отправка --------
document.getElementById("inputForm").onsubmit = async function(e){
    e.preventDefault();
    if(!selectedUser) { alert("Select a user first"); return; }
    const msg = document.getElementById("messageInput").value;
    if(!msg.trim()) return;
    await fetch(SERVER+"/send", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({sender:userId, recipient:selectedUser.id, text:msg})
    });
    document.getElementById("messageInput").value="";
    loadMessages();
}

// -------- Автообновление --------
setInterval(loadMessages,1500);

(async function(){
    if(!userId) await registerUser();
    document.getElementById("myId").textContent = userId;
    if(contacts.length===0) await addContact();
    renderContacts();
})();
</script>

</body>
</html>
