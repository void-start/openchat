<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>HackerChat Web</title>
<style>
body { margin:0; font-family:monospace; background:black; color:#0f0;}
#header { padding:10px; border-bottom:1px solid #0f0; background:#010; display:flex; justify-content:space-between; align-items:center;}
#container { display:flex; height:calc(100vh - 40px);}
#users { width:250px; background:#010; overflow-y:auto; border-right:1px solid #0f0; padding:5px;}
#chat { flex:1; display:flex; flex-direction:column;}
#messages { flex:1; padding:10px; overflow-y:auto;}
#inputForm { display:flex; border-top:1px solid #0f0;}
#inputForm input { flex:1; background:black; color:#0f0; border:none; padding:10px;}
#inputForm button { background:#0f0; color:black; border:none; padding:10px 15px; cursor:pointer;}
.user-item { padding:5px; cursor:pointer;}
.user-item:hover { background:#020; }
.user-item.active { background:#050; }
#addContactBtn { margin:5px; padding:5px; background:#0f0; color:black; cursor:pointer; text-align:center;}
#resetBtn { background:#000; border:1px solid #0f0; color:#0f0; padding:5px 10px; cursor:pointer; transition:0.2s;}
#resetBtn:hover { background:#0f0; color:black; }
</style>
</head>
<body>

<div id="header">
    <span>Your ID: <span id="myId">loading...</span></span>
    <button id="resetBtn">[ RESET DB ]</button>
</div>

<div id="container">
    <div id="users">
        <div id="addContactBtn">+ Add Contact</div>
    </div>
    <div id="chat">
        <div id="messages"></div>
        <form id="inputForm">
            <input id="messageInput" autocomplete="off" placeholder="Type a message"/>
            <button>Send</button>
        </form>
    </div>
</div>

<script>
const SERVER = window.location.origin;
let token = localStorage.getItem("token");
let userId = localStorage.getItem("userId");
let contacts = JSON.parse(localStorage.getItem("contacts")||"[]");
let selectedUser = null;

// -------- Регистрация / Логин --------
async function ensureAuth() {
    if (token && userId) return;

    const username = prompt("Enter username:");
    const password = prompt("Enter password:");

    // пробуем логин
    let resp = await fetch(SERVER+"/login", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({username,password})
    });

    if (resp.status !== 200) {
        // если не зашёл → регистрируем
        resp = await fetch(SERVER+"/register", {
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body: JSON.stringify({username,password})
        });
    }

    const data = await resp.json();
    token = data.token;
    userId = data.user_id;
    localStorage.setItem("token", token);
    localStorage.setItem("userId", userId);
}

// -------- Контакты --------
async function addContact() {
    const newId = prompt("Enter user ID:");
    if(!newId) return;
    if(!contacts.find(c => c.id===newId)){
        contacts.push({id:newId, name:newId.substring(0,6)});
        localStorage.setItem("contacts", JSON.stringify(contacts));
    }
    renderContacts();
}

function renderContacts(){
    const usersDiv = document.getElementById("users");
    usersDiv.innerHTML = '<div id="addContactBtn">+ Add Contact</div>';
    document.getElementById("addContactBtn").onclick = addContact;
    contacts.forEach(u=>{
        const div = document.createElement("div");
        div.textContent = u.name;
        div.className = "user-item" + (selectedUser && selectedUser.id===u.id ? " active" : "");
        div.onclick = ()=>{
            selectedUser = u;
            renderContacts();
            loadMessages();
        };
        usersDiv.appendChild(div);
    });
}

// -------- Сообщения --------
async function loadMessages(){
    if(!selectedUser) return;
    // исправлено: используем правильный эндпоинт с userId
    const resp = await fetch(`${SERVER}/inbox/${userId}`);
    const msgs = await resp.json();
    const chatDiv = document.getElementById("messages");
    chatDiv.innerHTML = "";
    msgs.forEach(m=>{
        if((m.sender===selectedUser.id && m.recipient===userId) || 
           (m.sender===userId && m.recipient===selectedUser.id)){
            const div = document.createElement("div");
            div.textContent = (m.sender===userId ? "Me" : selectedUser.display_name)+": "+m.text;
            chatDiv.appendChild(div);
        }
    });
    chatDiv.scrollTop = chatDiv.scrollHeight;
}

// -------- Отправка --------
document.getElementById("inputForm").onsubmit = async function(e){
    e.preventDefault();
    if(!selectedUser) { alert("Select a user first"); return; }
    const msg = document.getElementById("messageInput").value;
    if(!msg.trim()) return;
    // исправлено: отправка без ?token
    await fetch(SERVER+"/send", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({sender:userId, recipient:selectedUser.id, text:msg})
    });
    document.getElementById("messageInput").value="";
    loadMessages();
}

// -------- Сброс базы --------
document.getElementById("resetBtn").onclick = async function(){
    const pwd = prompt("Enter reset password:");
    if(!pwd) return;
    const resp = await fetch(`${SERVER}/reset?password=${pwd}`, {method:"POST"});
    const data = await resp.json();
    alert(JSON.stringify(data));
    localStorage.clear();
    location.reload();
}

// -------- Автообновление --------
setInterval(loadMessages,2000);

(async function(){
    await ensureAuth();
    document.getElementById("myId").textContent = userId;
    renderContacts();
})();
</script>

</body>
</html>
