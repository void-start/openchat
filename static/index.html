<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>HackerChat</title>
<style>
  :root {
    --bg:#000; --ink:#0f0; --panel:#010; --line:#0f0;
  }
  * { box-sizing:border-box; }
  body { margin:0; font-family:monospace; background:var(--bg); color:var(--ink);}

  #header { padding:10px; border-bottom:1px solid var(--line); background:var(--panel); display:flex; justify-content:space-between; align-items:center;}
  #container { display:flex; height:calc(100vh - 40px);}
  #users { width:240px; background:var(--panel); border-right:1px solid var(--line); overflow-y:auto;}
  #chat { flex:1; display:flex; flex-direction:column; }
  #topicBar { padding:8px 10px; border-bottom:1px solid var(--line); background:#000; font-weight:bold; }
  #messages { flex:1; padding:10px; overflow-y:auto; }
  #inputForm { display:flex; gap:6px; border-top:1px solid var(--line); padding:8px; }

  #inputForm input, #inputForm button { flex:1; }
  input, button {
    background:#000;
    color:var(--ink);
    border:1px solid var(--line);
    padding:6px 8px;
    font-family:monospace;
  }

  button { cursor:pointer; transition: all .2s; }
  button:hover { background:#020; box-shadow:0 0 6px #0f0; }
  button:active { background:#040; }

  #messages .line { margin-bottom:6px; }
  #messages .me { color:#9f9; }
  #users .item { padding:8px 10px; border-bottom:1px solid #060; cursor:pointer; }
  #users .item.active { background:#020; font-weight:bold; }
  #users .item .tag { opacity:.8; font-size:12px; }
  .toolbar { display:flex; gap:8px; }

  #loginForm, #registerForm, #adminForm {
    position:fixed;
    top:50%; left:50%;
    transform:translate(-50%, -50%);
    background:#000;
    border:1px solid var(--line);
    padding:20px;
    width:280px;
    text-align:center;
    box-shadow:0 0 12px #0f0;
    z-index:100;
  }
  .hidden { display:none; }

  /* --- –í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫ --- */
  #videoPanel {
    position:fixed;
    bottom:10px; right:10px;
    background:#000;
    border:1px solid var(--line);
    padding:10px;
    display:flex;
    flex-direction:column;
    gap:6px;
    box-shadow:0 0 12px #0f0;
    z-index:50;
  }
  #videoPanel video {
    width:200px; height:150px;
    background:#111;
    border:1px solid var(--line);
    object-fit:cover;
  }
</style>
</head>
<body>

<div id="header">
  <span id="userInfo">Not logged in</span>
  <div class="toolbar">
    <button id="loginBtn">Login</button>
    <button id="adminBtn">Admin</button>
    <button id="logoutBtn" class="hidden">Logout</button>
    <button id="callBtn" class="hidden">Call</button>
    <button id="hangupBtn" class="hidden">Hangup</button>
  </div>
</div>

<div id="container">
  <div id="users"></div>
  <div id="chat">
    <div id="topicBar">üåê Global chat</div>
    <div id="messages"></div>
    <form id="inputForm" class="hidden">
      <input id="messageInput" type="text" placeholder="Type a message‚Ä¶" autocomplete="off" />
      <button type="submit">Send</button>
    </form>
  </div>
</div>

<div id="videoPanel" class="hidden">
  <video id="localVideo" autoplay muted playsinline></video>
  <video id="remoteVideo" autoplay playsinline></video>
</div>

<!-- Auth Forms -->
<div id="loginForm" class="hidden">
  <h3>Login</h3>
  <input id="loginName" placeholder="Login"><br><br>
  <input id="loginPass" type="password" placeholder="Password"><br><br>
  <button type="button" onclick="doLogin()">Login</button>
  <button type="button" onclick="showRegister()">Register</button>
</div>

<div id="registerForm" class="hidden">
  <h3>Register</h3>
  <input id="regName" placeholder="Login"><br><br>
  <input id="regPass" type="password" placeholder="Password"><br><br>
  <button type="button" onclick="doRegister()">Register</button>
  <button type="button" onclick="showLogin()">Back</button>
</div>

<div id="adminForm" class="hidden">
  <h3>Admin</h3>
  <input id="adminPwd" type="password" placeholder="Password"><br><br>
  <button type="button" onclick="adminLogin()">Enter</button>
</div>

<script>
const SERVER = window.location.origin;
let currentUser = null;
let adminPwd = null;
let selectedScope = "global";
let selectedPeer = "all";
let pollTimer = null;

// --- Video call ---
let ws, pc, localStream, remoteStream, peerId;

function connectWS(){
  if(!currentUser) return;
  ws = new WebSocket(`ws://${location.host}/ws/${currentUser.user_id}`);
  ws.onmessage = async (event)=>{
    const msg = JSON.parse(event.data);
    if(msg.type==="offer"){ await handleOffer(msg); }
    else if(msg.type==="answer"){ await pc.setRemoteDescription(new RTCSessionDescription(msg.data)); }
    else if(msg.type==="candidate"){ await pc.addIceCandidate(new RTCIceCandidate(msg.data)); }
  };
}

async function startCall(){
  if(selectedPeer==="all"){ alert("Select user for call"); return; }
  peerId = selectedPeer;
  pc = new RTCPeerConnection();

  localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
  localStream.getTracks().forEach(t=>pc.addTrack(t, localStream));
  document.getElementById("localVideo").srcObject = localStream;

  remoteStream = new MediaStream();
  pc.ontrack = e=>e.streams[0].getTracks().forEach(t=>remoteStream.addTrack(t));
  document.getElementById("remoteVideo").srcObject = remoteStream;

  pc.onicecandidate = e=>{
    if(e.candidate) ws.send(JSON.stringify({to:peerId,type:"candidate",data:e.candidate}));
  };

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  ws.send(JSON.stringify({to:peerId,type:"offer",data:offer}));

  document.getElementById("videoPanel").classList.remove("hidden");
  document.getElementById("hangupBtn").classList.remove("hidden");
}

async function handleOffer(msg){
  peerId = msg.from;
  pc = new RTCPeerConnection();

  localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
  localStream.getTracks().forEach(t=>pc.addTrack(t, localStream));
  document.getElementById("localVideo").srcObject = localStream;

  remoteStream = new MediaStream();
  pc.ontrack = e=>e.streams[0].getTracks().forEach(t=>remoteStream.addTrack(t));
  document.getElementById("remoteVideo").srcObject = remoteStream;

  pc.onicecandidate = e=>{
    if(e.candidate) ws.send(JSON.stringify({to:peerId,type:"candidate",data:e.candidate}));
  };

  await pc.setRemoteDescription(new RTCSessionDescription(msg.data));
  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);
  ws.send(JSON.stringify({to:peerId,type:"answer",data:answer}));

  document.getElementById("videoPanel").classList.remove("hidden");
  document.getElementById("hangupBtn").classList.remove("hidden");
}

function hangup(){
  if(pc){ pc.close(); pc=null; }
  if(localStream){ localStream.getTracks().forEach(t=>t.stop()); }
  document.getElementById("videoPanel").classList.add("hidden");
  document.getElementById("hangupBtn").classList.add("hidden");
}

// --- (–æ—Å—Ç–∞–ª—å–Ω–æ–π —Ç–≤–æ–π –∫–æ–¥ —á–∞—Ç–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
// ... (–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è, —Å–æ–æ–±—â–µ–Ω–∏—è, polling, admin –∏ —Ç.–¥.) ...

// –ø–æ—Å–ª–µ doLogin:
async function doLogin(){
  // —Ç–≤–æ–π —Å—Ç–∞—Ä—ã–π –∫–æ–¥...
  currentUser = d;
  document.getElementById("userInfo").textContent = "Logged as " + d.username;
  setAuthUI(true);
  hideAll();
  await refreshUsers();
  selectGlobal();
  startPolling();
  connectWS(); // <--- –ø–æ–¥–∫–ª—é—á–∞–µ–º WS –¥–ª—è –∑–≤–æ–Ω–∫–æ–≤
}

// –∫–Ω–æ–ø–∫–∏
document.getElementById("callBtn").onclick = startCall;
document.getElementById("hangupBtn").onclick = hangup;
</script>
</body>
</html>
