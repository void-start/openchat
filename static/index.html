<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>HackerChat Web</title>
<style>
body { margin:0; font-family:monospace; background:black; color:#0f0;}
#header { padding:10px; border-bottom:1px solid #0f0; background:#010; display:flex; justify-content:space-between; align-items:center;}
#container { display:flex; height:calc(100vh - 40px);}
#users { width:250px; background:#010; overflow-y:auto; border-right:1px solid #0f0; padding:5px;}
#chat { flex:1; display:flex; flex-direction:column;}
#messages { flex:1; padding:10px; overflow-y:auto;}
#inputForm { display:flex; border-top:1px solid #0f0;}
#inputForm input[type="text"] { flex:1; background:black; color:#0f0; border:none; padding:10px;}
#inputForm input[type="file"] { background:#020; color:#0f0; border:1px solid #0f0; margin-left:5px; cursor:pointer;}
#inputForm button { background:#0f0; color:black; border:none; padding:10px 15px; cursor:pointer;}
.user-item { padding:5px; cursor:pointer;}
.user-item:hover { background:#020; }
.user-item.active { background:#050; }
#addContactBtn { margin:5px; padding:5px; background:#0f0; color:black; cursor:pointer; text-align:center;}
#resetBtn, #loginBtn { background:#000; border:1px solid #0f0; color:#0f0; padding:5px 10px; cursor:pointer; transition:0.2s; margin-left:5px;}
#resetBtn:hover, #loginBtn:hover { background:#0f0; color:black; }
</style>
</head>
<body>

<div id="header">
    <span>Your ID: <span id="myId">loading...</span></span>
    <div>
        <button id="loginBtn">[ Login/Register ]</button>
        <button id="resetBtn">[ RESET DB ]</button>
    </div>
</div>

<div id="container">
    <div id="users">
        <div id="addContactBtn">+ Add Contact</div>
    </div>
    <div id="chat">
        <div id="messages"></div>
        <form id="inputForm">
            <input id="messageInput" type="text" autocomplete="off" placeholder="Type a message"/>
            <input id="fileInput" type="file"/>
            <button>Send</button>
        </form>
    </div>
</div>

<script>
const SERVER = window.location.origin;
let userId = localStorage.getItem("userId");
let displayName = localStorage.getItem("displayName");
let contacts = JSON.parse(localStorage.getItem("contacts")||"[]");
let selectedUser = null;

// --- Login/Register ---
async function loginOrRegister() {
    let nickname = prompt("Enter your nickname:") || "Anon";
    const resp = await fetch(SERVER+"/login", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({display_name: nickname})
    });
    const data = await resp.json();
    userId = data.user_id;
    displayName = data.display_name;
    localStorage.setItem("userId", userId);
    localStorage.setItem("displayName", displayName);
    document.getElementById("myId").textContent = userId;
}

// --- Contacts ---
async function addContact() {
    const newId = prompt("Enter user ID:");
    if(!newId) return;
    if(!contacts.find(c => c.id===newId)){
        contacts.push({id:newId, display_name:newId.substring(0,6)});
        localStorage.setItem("contacts", JSON.stringify(contacts));
    }
    renderContacts();
}

function renderContacts(){
    const usersDiv = document.getElementById("users");
    usersDiv.innerHTML = '<div id="addContactBtn">+ Add Contact</div>';
    document.getElementById("addContactBtn").onclick = addContact;
    contacts.forEach(u=>{
        const div = document.createElement("div");
        div.textContent = u.display_name;
        div.className = "user-item" + (selectedUser && selectedUser.id===u.id ? " active" : "");
        div.onclick = ()=>{
            selectedUser = u;
            renderContacts();
            loadMessages();
        };
        usersDiv.appendChild(div);
    });
}

// --- Load messages ---
async function loadMessages(){
    if(!selectedUser) return;
    const resp = await fetch(`${SERVER}/inbox/${userId}`);
    const msgs = await resp.json();
    const chatDiv = document.getElementById("messages");
    chatDiv.innerHTML = "";
    msgs.forEach(m=>{
        if((m.sender===selectedUser.id && m.recipient===userId) || 
           (m.sender===userId && m.recipient===selectedUser.id)){
            if(m.text.startsWith("[file]")){
                const filename = m.text.replace("[file]","");
                const ext = filename.split('.').pop().toLowerCase();
                if(["jpg","jpeg","png","gif","webp"].includes(ext)){
                    const img = document.createElement("img");
                    img.src = SERVER+"/media/"+filename;
                    img.style.maxWidth="200px";
                    chatDiv.appendChild(img);
                } else {
                    const a = document.createElement("a");
                    a.href = SERVER+"/media/"+filename;
                    a.textContent = "ðŸ“Ž File";
                    a.target="_blank";
                    chatDiv.appendChild(a);
                }
            } else {
                const div = document.createElement("div");
                div.textContent = (m.sender===userId?"Me":selectedUser.display_name)+": "+m.text;
                chatDiv.appendChild(div);
            }
        }
    });
    chatDiv.scrollTop = chatDiv.scrollHeight;
}

// --- Send message ---
document.getElementById("inputForm").onsubmit = async function(e){
    e.preventDefault();
    if(!selectedUser) { alert("Select a user first"); return; }

    const msg = document.getElementById("messageInput").value;
    const file = document.getElementById("fileInput").files[0];

    if(file){
        const formData = new FormData();
        formData.append("sender", userId);
        formData.append("recipient", selectedUser.id);
        formData.append("file", file);
        await fetch(SERVER+"/send_file", { method:"POST", body:formData });
        document.getElementById("fileInput").value="";
    }
    if(msg.trim()){
        await fetch(SERVER+"/send", {
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body: JSON.stringify({sender:userId, recipient:selectedUser.id, text:msg})
        });
        document.getElementById("messageInput").value="";
    }
    loadMessages();
}

// --- Reset DB ---
document.getElementById("resetBtn").onclick = async function(){
    const pwd = prompt("Enter reset password:");
    if(!pwd) return;
    const resp = await fetch(`${SERVER}/reset?password=${pwd}`, {method:"POST"});
    const data = await resp.json();
    alert(JSON.stringify(data));
}

// --- Login/Register Button ---
document.getElementById("loginBtn").onclick = loginOrRegister;

// --- Auto-update ---
setInterval(loadMessages, 2000);

// --- Init ---
(async function(){
    if(!userId) await loginOrRegister();
    document.getElementById("myId").textContent = userId;
    renderContacts();
})();
</script>
</body>
</html>
