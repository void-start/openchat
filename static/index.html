<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>HackerChat</title>
<style>
body { margin:0; font-family:monospace; background:black; color:#0f0;}
#header { padding:10px; border-bottom:1px solid #0f0; background:#010; display:flex; justify-content:space-between;}
#container { display:flex; height:calc(100vh - 40px);}
#users { width:200px; background:#010; border-right:1px solid #0f0; overflow-y:auto;}
#chat { flex:1; display:flex; flex-direction:column;}
#messages { flex:1; padding:10px; overflow-y:auto;}
#inputForm { display:flex; border-top:1px solid #0f0;}
#inputForm input, #inputForm button { background:black; color:#0f0; border:1px solid #0f0; padding:5px; }
#loginForm, #registerForm, #adminForm { padding:20px; }
.hidden { display:none; }
</style>
</head>
<body>

<div id="header">
  <span id="userInfo">Not logged in</span>
  <div>
    <button id="loginBtn">Login</button>
    <button id="adminBtn">Admin</button>
    <button id="logoutBtn" class="hidden">Logout</button>
  </div>
</div>

<div id="container">
  <div id="users"></div>
  <div id="chat">
    <div id="messages"></div>
    <form id="inputForm" class="hidden">
      <input id="messageInput" type="text" placeholder="Type..."/>
      <input id="fileInput" type="file"/>
      <button>Send</button>
    </form>
  </div>
</div>

<!-- Forms -->
<div id="loginForm" class="hidden">
  <h3>Login</h3>
  <input id="loginName" placeholder="Login"><br>
  <input id="loginPass" type="password" placeholder="Password"><br>
  <button onclick="doLogin()">Login</button>
  <button onclick="showRegister()">Register</button>
</div>

<div id="registerForm" class="hidden">
  <h3>Register</h3>
  <input id="regName" placeholder="Login"><br>
  <input id="regPass" type="password" placeholder="Password"><br>
  <button onclick="doRegister()">Register</button>
  <button onclick="showLogin()">Back</button>
</div>

<div id="adminForm" class="hidden">
  <h3>Admin</h3>
  <input id="adminPwd" type="password" placeholder="Password"><br>
  <button onclick="adminLogin()">Enter</button>
</div>

<script>
const SERVER = window.location.origin;
let currentUser = null;
let selectedUser = null;

// UI control
function showLogin(){ hideAll(); document.getElementById("loginForm").classList.remove("hidden"); }
function showRegister(){ hideAll(); document.getElementById("registerForm").classList.remove("hidden"); }
function showAdmin(){ hideAll(); document.getElementById("adminForm").classList.remove("hidden"); }
function hideAll(){ document.querySelectorAll("#loginForm,#registerForm,#adminForm").forEach(e=>e.classList.add("hidden")); }

// Login/Register
async function doLogin(){
  const login=document.getElementById("loginName").value;
  const pass=document.getElementById("loginPass").value;
  const r=await fetch(SERVER+"/login",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({login,password:pass})
  });
  const d=await r.json();
  if(d.error){
    alert(d.error);
  } else {
    currentUser=d;
    document.getElementById("userInfo").textContent="Logged as "+d.username;
    document.getElementById("inputForm").classList.remove("hidden");
    document.getElementById("logoutBtn").classList.remove("hidden");
    hideAll();
    loadMessages();
  }
}


async function doRegister(){
  const login=document.getElementById("regName").value;
  const pass=document.getElementById("regPass").value;
  const r=await fetch(SERVER+"/register",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({login,password:pass})});
  const d=await r.json();
  if(d.error){alert(d.error);}else{alert("Registered, now login"); showLogin();}
}

async function doLogout(){
  await fetch(SERVER+"/logout",{method:"POST"});
  currentUser=null;
  document.getElementById("userInfo").textContent="Not logged in";
  document.getElementById("inputForm").classList.add("hidden");
  document.getElementById("logoutBtn").classList.add("hidden");
  showLogin();
}

// Messages
async function loadMessages(){
  if(!currentUser) return;
  const r=await fetch(SERVER+"/inbox");
  const msgs=await r.json();
  const box=document.getElementById("messages");
  box.innerHTML="";
  msgs.forEach(m=>{
    const div=document.createElement("div");
    div.textContent=(m.sender===currentUser.user_id?"Me":"Other")+": "+m.text;
    box.appendChild(div);
  });
  box.scrollTop=box.scrollHeight;
}
setInterval(loadMessages,2000);

document.getElementById("inputForm").onsubmit=async e=>{
  e.preventDefault();
  const msg=document.getElementById("messageInput").value;
  if(!msg.trim()) return;
  await fetch(SERVER+"/send",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({recipient:"all",text:msg})});
  document.getElementById("messageInput").value="";
  loadMessages();
};

// Admin
async function adminLogin(){
  const pwd=document.getElementById("adminPwd").value;
  const r=await fetch(SERVER+"/admin_login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({password:pwd})});
  const d=await r.json();
  if(d.error){alert(d.error);}else{ loadAdmin(); }
}

async function loadAdmin(){
  const r=await fetch(SERVER+"/admin_panel");
  const d=await r.json();
  if(d.error){alert(d.error);return;}
  let html="<h3>Admin Panel</h3><button onclick='resetDB()'>Reset DB</button><ul>";
  for(const u in d.users){ html+=`<li>${u} / ${d.users[u].password}</li>`; }
  html+="</ul>";
  document.getElementById("adminForm").innerHTML=html;
}
async function resetDB(){
  const r=await fetch(SERVER+"/admin_reset",{method:"POST"});
  const d=await r.json();
  alert(JSON.stringify(d));
  loadAdmin();
}

// Buttons
document.getElementById("loginBtn").onclick=showLogin;
document.getElementById("adminBtn").onclick=showAdmin;
document.getElementById("logoutBtn").onclick=doLogout;

showLogin();
</script>
</body>
</html>
