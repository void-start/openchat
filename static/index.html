<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>HackerChat</title>
<style>
body { margin:0; font-family:monospace; background:black; color:#0f0;}
#header { padding:10px; border-bottom:1px solid #0f0; background:#010; display:flex; justify-content:space-between;}
#container { display:flex; height:calc(100vh - 40px);}
#users { width:200px; background:#010; border-right:1px solid #0f0; overflow-y:auto;}
#chat { flex:1; display:flex; flex-direction:column;}
#messages { flex:1; padding:10px; overflow-y:auto;}
#inputForm { display:flex; border-top:1px solid #0f0;}
#inputForm input, #inputForm button { background:black; color:#0f0; border:1px solid #0f0; padding:5px; }
#loginForm, #registerForm, #adminForm { padding:20px; }
.hidden { display:none; }
</style>
</head>
<body>

<div id="header">
  <span id="userInfo">Not logged in</span>
  <div>
    <button id="loginBtn">Login</button>
    <button id="adminBtn">Admin</button>
    <button id="logoutBtn" class="hidden">Logout</button>
  </div>
</div>

<div id="container">
  <div id="users"></div>
  <div id="chat">
    <div id="messages"></div>
    <form id="inputForm" class="hidden">
      <input id="messageInput" type="text" placeholder="Type..." autocomplete="off"/>
      <input id="fileInput" type="file"/>
      <button type="submit">Send</button>
    </form>
  </div>
</div>

<div id="loginForm" class="hidden">
  <h3>Login</h3>
  <form id="loginFormInner">
    <input id="loginName" placeholder="Login" required><br>
    <input id="loginPass" type="password" placeholder="Password" required><br>
    <button type="submit">Login</button>
    <button type="button" onclick="showRegister()">Register</button>
  </form>
</div>

<div id="registerForm" class="hidden">
  <h3>Register</h3>
  <form id="registerFormInner">
    <input id="regName" placeholder="Login" required><br>
    <input id="regPass" type="password" placeholder="Password" required><br>
    <button type="submit">Register</button>
    <button type="button" onclick="showLogin()">Back</button>
  </form>
</div>

<div id="adminForm" class="hidden">
  <h3>Admin</h3>
  <form id="adminFormInner">
    <input id="adminPwd" type="password" placeholder="Password" required><br>
    <button type="submit">Enter</button>
  </form>
</div>

<script>
const SERVER = window.location.origin;
let currentUser = null;
let selectedUser = null;

// UI control
function showLogin(){ hideAll(); document.getElementById("loginForm").classList.remove("hidden"); }
function showRegister(){ hideAll(); document.getElementById("registerForm").classList.remove("hidden"); }
function showAdmin(){ hideAll(); document.getElementById("adminForm").classList.remove("hidden"); }
function hideAll(){ document.querySelectorAll("#loginForm,#registerForm,#adminForm").forEach(e=>e.classList.add("hidden")); }

// Event listeners for forms
document.getElementById("loginFormInner").addEventListener("submit", async (e) => {
  e.preventDefault();
  await doLogin();
});

document.getElementById("registerFormInner").addEventListener("submit", async (e) => {
  e.preventDefault();
  await doRegister();
});

document.getElementById("adminFormInner").addEventListener("submit", async (e) => {
  e.preventDefault();
  await adminLogin();
});

// Login/Register
async function doLogin(){
  const username=document.getElementById("loginName").value;
  const password=document.getElementById("loginPass").value;

  const formData = new FormData();
  formData.append("username", username);
  formData.append("password", password);

  try {
    const r=await fetch(SERVER+"/login",{
        method:"POST",
        body: formData
    });
    const d=await r.json();
    if(d.error){
      alert("Login failed: "+d.error);
    } else {
      currentUser=d;
      document.getElementById("userInfo").textContent="Logged as "+d.username;
document.getElementById("inputForm").classList.remove("hidden");
      document.getElementById("logoutBtn").classList.remove("hidden");
      document.getElementById("loginBtn").classList.add("hidden");
      hideAll();
      loadMessages();
    }
  } catch (e) {
    alert("An error occurred. Please try again.");
  }
}

async function doRegister(){
  const username=document.getElementById("regName").value;
  const password=document.getElementById("regPass").value;

  const formData = new FormData();
  formData.append("username", username);
  formData.append("password", password);

  try {
    const r=await fetch(SERVER+"/register",{method:"POST",body:formData});
    const d=await r.json();
    if(d.error){
      alert("Registration failed: "+d.error);
    } else {
      alert("Registered, now login");
      showLogin();
    }
  } catch (e) {
    alert("An error occurred. Please try again.");
  }
}

async function doLogout(){
  currentUser=null;
  document.getElementById("userInfo").textContent="Not logged in";
  document.getElementById("inputForm").classList.add("hidden");
  document.getElementById("logoutBtn").classList.add("hidden");
  document.getElementById("loginBtn").classList.remove("hidden");
  showLogin();
}

// Messages
async function loadMessages(){
  if(!currentUser) return;
  const r=await fetch(SERVER+"/inbox");
  const msgs=await r.json();
  const box=document.getElementById("messages");
  box.innerHTML="";
  msgs.forEach(m=>{
    const div=document.createElement("div");
    div.textContent=(m.sender===currentUser.user_id?"Me":"Other")+": "+m.text;
    box.appendChild(div);
  });
  box.scrollTop=box.scrollHeight;
}
setInterval(loadMessages,2000);

document.getElementById("inputForm").onsubmit=async e=>{
  e.preventDefault();
  const msg=document.getElementById("messageInput").value;
  if(!msg.trim()) return;
  const formData = new FormData();
  formData.append("recipient", "all");
  formData.append("text", msg);
  await fetch(SERVER+"/send",{method:"POST",body:formData});
  document.getElementById("messageInput").value="";
  loadMessages();
};

// Admin
async function adminLogin(){
  const password=document.getElementById("adminPwd").value;
  const formData = new FormData();
  formData.append("password", password);
  try {
    const r=await fetch(SERVER+"/admin/login",{method:"POST",body:formData});
    const d=await r.json();
    if(d.error){
      alert("Admin login failed: "+d.error);
    } else {
      loadAdmin();
    }
  } catch (e) {
    alert("An error occurred. Please try again.");
  }
}

async function loadAdmin(){
  const password=document.getElementById("adminPwd").value;
  const r=await fetch(SERVER+"/admin/users?password="+encodeURIComponent(password));
  const d=await r.json();
  if(d.error){alert(d.error);return;}
  let html="<h3>Admin Panel</h3><button onclick='resetDB()'>Reset DB</button><ul>";
  for(const u of d.users){ html+=<li>${u.username}</li>; } // Only display usernames
  html+="</ul>";
  document.getElementById("adminForm").innerHTML=html;
}

async function resetDB(){
  const password = document.getElementById("adminPwd").value;
  const formData = new FormData();
  formData.append("password", password);
  const r=await fetch(SERVER+"/admin/reset",{method:"POST",body:formData});
  const d=await r.json();
  alert(JSON.stringify(d));
  loadAdmin();
}

// Buttons
document.getElementById("loginBtn").onclick=showLogin;
document.getElementById("adminBtn").onclick=showAdmin;
document.getElementById("logoutBtn").onclick=doLogout;

showLogin();
</script>
</body>
</html>